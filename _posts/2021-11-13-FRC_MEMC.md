---
title: Computer Vision - FRC and MEMC 
date: 2021-11-13 11:10:08
categories:
- AI
tags: [FRC, MEMC, Deformable Convolution]
typora-root-url: ../../allenlu2009.github.io

---

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>


## Main Reference

* [@santamariaEntropyMutual2015]



## FRC - Frame Rate Conversion

FRC 顧名思義就是做幀率轉換，一般是從低幀率轉換成高幀率。爲什麽需要做 FRC? 有兩個原因：(1) bridge video/game content frame rate and device refresh rate; (2) 高幀率 (HFR - High Frame Rate) 提高 video or game 的流暢性 (smoothness)，這是目前主流或是高階電視和手機的賣點。

#### Video Content Frame Rate  

大多電影拍攝還是 native 24 FPS (李安的 ***Billy Lynn's Long Halftime Walk*** 是史上最高電影使用 native 120 FPS).  TV 和 Game 大多是 native 30, 60 (少數 120 FPS).  Video call 例如 WeChat, Line, Zoom 可能用不到 10 FPS 的 video stream 節省頻寬和遲延 (latency).  

#### Device Refresh Rate

主流電視 (2021) 的 refresh rate 是 60Hz; 高階電視可以到 120Hz, 甚至 240Hz (大多是插黑幀)。主流旗艦手機 (2021) 的 refresh rate 是 120Hz.  



下表 summarize video content 和 device refresh rate 的 gap, 需要 FRC to bridge the gap.

| Video Cotent Frame Rate | Device Refresh Rate             |
| ----------------------- | ------------------------------- |
| Movie: 24 FPS           | TV device: 60/120/240Hz         |
| TV video: 30, 60 FPS    | Smart phone device: 60/90/120Hz |
| Game: 30, 60, 90 FPS    |                                 |
| Video call: 15/10 FPS   |                                 |



### Smoothness

以上是單從 bridge video/game content and device refresh rate 出發。**如果只是這個目的，最簡單的方法就是插重複幀，或者插黑幀。**

我們舉一個實際的例子，例如 movie content 是 24 FPS, 但要在 60 Hz TV 顯示。 最簡單的方法就是如下的插幀。

不單是插重複幀，而且還不是均匀插幀。而是 2-3-2-3 插幀。兩個問題 (1) 不均匀插幀會造成視覺上有顫抖 (judder) 現象，Youtube 有一些影片可以參考；(2) 低 frame rate (e.g. 24 FPS) 雖然有所謂的 “電影感", 但在内容有高速運動的畫面 (e.g. 球賽或是打鬥) 就會顯得模糊[^1]。

[^1]: 電影一般用特效 (e.g. slow motion) 處理。

<img src="/media/image-20211114012107075.png" alt="image-20211114012107075" style="zoom: 67%;" />

實務上沒有任何電視會用這種方法做 24 to 60 FPS 的 FRC.  這就會帶到下一個題目, MEMC.



## MEMC - Motion Estimation Motion Compensation

FRC 是一個規格需求，從 A FPS 轉到 B FPS, 一般 B > A.  最簡單的做法是（不均匀）重複插幀或是插黒幀。不過沒有電視這樣做，因爲視覺感受 (visual perception) 不好。 

目前主流的方法就是對 native frames, e.g. N and N+1 at 24 FPS, 做 motion estimatin (ME), 再根據要插出的幀的時間做 motion compensation (MC), e.g. M, M+1, ..., M+5 at 60 FPS, 也就是 2 個 input frames 產生 5 個 output frames (24FPS to 60FPS).   ME 加 MC 合稱爲 MEMC.

#### Forward and Backward Motion Map

我們用一個最簡單也是目前最常用的 MEMC 爲例，如下圖:  input frame rate N at 30FPS, output frame rate M at 60 FPS, conversion rate 為 2.   兩張 input frames, 叫做 $I_0$ and $I_1$, 可以計算或搜尋出 forward motion (vector) map, 就是 image 的每一個 pixel 都有對應的 motion vector, 稱爲 $F_{0\to1}$.  這個過程就是 ME (motion estimation).  再來藉助 $I_0$ 和 $F_{0\to 1}$，就可以 forward warp 出 $I_{0.5}$ output frame. 這個過程就是 MC (motion compensation).  

**In summary:  ME 就是產生 motion map;  MC 就是用原來的 image 加上 motion map, warp 出 output image.**

上述 forward warp 並不是唯一的 ME-MC。我們也可以計算 backward motion (vector) map, 稱爲 $F_{1\to 0}$, 藉助 $I_1$ 和 $F_{1\to 0}$， 同樣可以 backward warp 出 $I_{0.5}$ output frame.   

**乍看之下，好像 forward motion map $F_{0\to 1}$ 和 backward motion map $F_{1\to 0}$ 是 reverse 的關係。其實不然。**

以下圖 original image 爲例，$F_{0\to 1}$ 在 $I_0$ 小車的位置的 motion vector 是前進，其他位置為 0.  但 $F_{1\to 0}$ 雖然 motion vector 是後退，和 $F_{0\to 1}$ 剛好是 reverse，但卻是在 $I_1$ 的小車位置，而不是在 $I_0$ 小車的位置，一般我們稱爲不同的 anchor point (錨定點)。所以 forward motion map $F_{1\to 0}$ 不是 backward motion map $F_{0\to 1}$ 的 reverse map，因爲 moving object 在不同 frame 的 anchor point 不同！  

#### More problem when occulusion occurs

The motion map is NOT 1-to-1, but many-to-1!!



### Back to Physics (Laplace Monster!)

**current object position and velocity, we can predict everything**

**Problem, we don't have velocity => easy, we use t_0 and t_1 for the velocity**

**Problem, 2D and 3D**

**Problem, new information, for example, a monkey jumping from the stone at t1 (I don't know where it is in t_0.5)! or move to a new scene!  => inpainting, best guess**





**Video use both forward and backward and blending for more information!**

爲了讓 picture quality 更好，一般我們也會估算 backward motion vector, 稱爲 $F_{1\to 0}$  







![image-20211218005026588](/media/image-20211218005026588.png)







MEMC 的技術基本分爲 (1) 傳統的方法和 (2) 深度學習的方法  [wikiVideoSuperresolution2021].

此處略過 (1)，主要介紹 (2) 深度學習的 MEMC.



Challenge

1.  3D to 2D so information is not complete, occusion problem without depth map!!  (ill-condition)
   1. 2D video Interpolation will suffer from the occusion problem
   2. 3D graphics (with depth map) interpolation does not have this problem, but graphic will not use this because of latency
2. Extrapolation has **additional** problem of information deficiency  (ill-condition)
   1. 2D Video will not use it because it's quality loss, and it can tolerate latency
   2. 3D Graphic suffer from this problem



#### MEMC Basic And Challenges

顧名思義，MEMC 分爲兩個部分: ME (Motion Estimation) and MC (Motion Compensation).  

#### Deep Learning Based MEMC

Deep Learning Based 可以分爲兩類：(A) ME and MC; (B) Deformable convolution.

##### ME-MC

Motion Estimation: provide information about the motion of pixels between frames.

Motion Compensation: a warping operation, which aligns one frame to another based on motion information.

| ME / MC                                           | Two frames Interpolation                                     | One Frame Extrapolation                                      |
| ------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| one motion                                        |                                                              |                                                              |
| Game, Motion/depth map from ground truth          |                                                              | forward warping                                              |
| XR, Motion/depth map from IMU sensor              |                                                              | forward warping                                              |
| Video, Motion/visual maps from consecutive frames | **Prefer backward warping for better quality:**  ideal two images blending, no inpainting; but has image halo issueto solve motion map halo (use motion map inpainting) | **Forward warping problem:** 1. predicted motion map error cause overshoot; 2. object occulusion w/o depth map;  3 Image inpainting |

對於 video 而言，ME 主要由連續 frames 產生，例如 optical flow.  基於 optical flow 的 深度學習有 FlowNet, RAFT, etc.  可以參考上文。

對於 game 而言，ME 有機會事先得知 (object motion based on physics), 不一定要用最後的 image frames 產生。 



##### Aligned by deformable convolution

一般 image 的 convolution 都是 fixed kernel (e.g. CNN).  Deformable convolution 則是先 estimate shifts for kernel and do convolution.



##### 3D Convolution



motion estimation: optical flow

#### AI-MEMC

##### 	AI motion estimation

​	FlowNet

​	RAFT

Kernel method

##### AI motion compensta





MEMC

- CV
- AI - 
- Kernel









